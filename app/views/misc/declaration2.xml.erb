<% enterprise = @declaration.enterprise %>
<% custom_option = enterprise.enterprise_custom_option %>
<% now = Time.now %>
<?xml version="1.0" encoding="UTF8"?>
<TCS101Message>
	<MessageHead>
    <MessageType>001</MessageType>
    <MessageId><%= custom_option.platform_id %><%= @serial_no %></MessageId>
    <MessageTime><%= now.strftime('%Y%m%d%H%M%S') %></MessageTime>
    <SenderId><%= custom_option.platform_id %></SenderId>
    <SenderAddress><%= custom_option.platform_id %>@<%= custom_option.area_name %></SenderAddress>
    <ReceiverId>T99999999999</ReceiverId>
    <ReceiverAddress>T99999999999@TCS10001</ReceiverAddress>
  </MessageHead>
  <MessageBody>
    <tcs:TcsFlow201 schemaLocation="http://www.chinaport.gov.cn/tcs/v2 TcsWorkFlow.xsd" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:tcs="http://www.chinaport.gov.cn/tcs/v2">
      <tcs:TcsUser>
      	<%= raw tcs("UserId", (custom_option.platform_id rescue '')) %>
      	<%= raw tcs("UserPrivateKey", (custom_option.user_private_key rescue '')) %>
      </tcs:TcsUser>
      <tcs:TcsLink>
        <tcs:TcsLinkMan>
		  <%= raw tcs("Name", (enterprise.linkman rescue '')) %>
		  <tcs:Department xsi:nil="true" />
          <tcs:Duty xsi:nil="true" />
          <%= raw tcs("Telephone", (enterprise.telephone rescue '')) %>
          <tcs:Mobile xsi:nil="true" />
          <%= raw tcs("Fax", (enterprise.fax rescue '')) %>
          <%= raw tcs("Address", (enterprise.address rescue '')) %>
          <tcs:ZipCode>1</tcs:ZipCode>
          <tcs:Email xsi:nil="true" />
          <tcs:ImCode>1</tcs:ImCode>
          <tcs:ImType>1</tcs:ImType>
        </tcs:TcsLinkMan>
      </tcs:TcsLink>
      <tcs:TcsFlow>
      	<tcs:MessageId><%= custom_option.platform_id %><%= @serial_no %></tcs:MessageId>
      	<%= raw tcs("BpNo", (custom_option.process_no rescue '')) %>
        <tcs:ActionList>
          <tcs:ActionId>a01</tcs:ActionId>
        </tcs:ActionList>
        <%= raw tcs("TaskId", (custom_option.platform_id + now.strftime('%Y%m%d') + @serial_no rescue '')) %>
        <tcs:TaskNote>黄埔-001</tcs:TaskNote>
        <tcs:CorpTaskId>
        </tcs:CorpTaskId>
        <tcs:TaskControl>
        </tcs:TaskControl>
      </tcs:TcsFlow>
			<tcs:TcsData>
				<DecDocument xsi:schemaLocation="http://www.chinaport.gov.cn/tcs/check DecLogicCheck.xsd" xmlns="http://www.chinaport.gov.cn/tcs/check" xmlns:xsi="http://www.w3.org/2001/XMLSchemainstance">
          <DecInfo>
          <SupplementType >0</SupplementType >
          </DecInfo>
			    <DecHead>
			       <%= raw tcs("EportNo", (@declaration.eport_no rescue '')) %>
			       <%= raw tcs("PreentryNo", (@declaration.pre_entry_no rescue '')) %>
			       <%= raw tcs("AgentCode", (@declaration.declare_enterprise_code rescue '')) %>
            <AgentName>东莞市新泽报关咨询服务有限公司</AgentName>
             <%= raw tcs("OwnerCode", (@declaration.enterprise.code rescue '')) %>
             <%= raw tcs("OwnerName", (@declaration.enterprise.name rescue '')) %>
             <%= raw tcs("TradeCode", (@declaration.operate_enterprise.code rescue '')) %>
             <%= raw tcs("TradeName", (@declaration.operate_enterprise.name rescue '')) %>
             <%= raw tcs("CustomMaster", (enterprise.enterprise_custom_option.custom_code rescue '')) %>
            <DeclTrnRel>0</DeclTrnRel>
             <%= raw tcs("DistinatePort", (@declaration.port rescue '')) %>
             <%= raw tcs("TradeCountry", (@declaration.trade_country rescue '')) %>
             <%= raw tcs("DestinationCode", ( @declaration.destination rescue '')) %>
            <%= raw tcs("ContractNo", ( @declaration.contract_no rescue '')) %>
             <%= raw tcs("EnrolNo", ( @declaration.contract.manual rescue '')) %>
             <%= raw tcs("ApprovalNo", (  @declaration.certification rescue '')) %>
             <%= raw tcs("MeansOfTransportName", (  @declaration.transport_tool rescue '')) %>
            <%= raw tcs("BillOfLadingNo", (  @declaration.bill_no rescue '')) %>
            <%= raw tcs("PackingType", (  @declaration.wrap_type rescue '')) %>
            <%= raw tcs("MeansOfTransportMode", (  @declaration.transport_mode rescue '')) %>
            <%= raw tcs("TransactionMode", (   @declaration.deal_mode rescue '')) %>
            <%= raw tcs("TradeMode", (   @declaration.trade_mode rescue '')) %>
            <%= raw tcs("CutMode", (   @declaration.tax_kind rescue '')) %>
            <%= raw tcs("ImportExportFlag", (  @declaration.declaration_type == 'export' ? 'E':'I' rescue '')) %>
            <%= raw tcs("Packages", (  @declaration.package_amount rescue '')) %>
            <%= raw tcs("NetWeight", (  @declaration.net_weight rescue '')) %>
            <%= raw tcs("GrossWeight", (  @declaration.gross_weight rescue '')) %>
             <%= raw tcs("PayMode", (  @declaration.pay_way rescue '')) %>
            <%= raw tcs("ImportExportDate", ( @declaration.import_export_date.strftime('%Y%m%d') if @declaration.import_export_date )) %>
            <%= raw tcs("PDate", ( @declaration.declare_date.strftime('%Y%m%d') if @declaration.declare_date)) %>
             <%= raw tcs("InputIcCode", (custom_option.ic_card_no rescue '')) %>
             <%= raw tcs("InputName", (@declaration.declarant rescue '')) %>
			    </DecHead>
			     <DecList>
			     <% @declaration.declaration_cargos.each do |cargo| %>
			         <DecListInformation>
                	<%= raw tcs("No", (cargo.no rescue '')) %>
                  <%= raw tcs("HsCode", (cargo.code rescue '')) %>
                  <tcs:MaterialNo xsi:nil="true" />
                  <%= raw tcs("GoodsName", (cargo.name rescue '')) %>
                  <%= raw tcs("Model", (cargo.specification rescue '')) %>
                  <% if @declaration.trade_mode == '0110' %>
                  <tcs:EnrolNo xsi:nil="true" />
                  <% else %>
                  <%= raw tcs("EnrolNo", (cargo.no_in_contract rescue '')) %>
                  <% end %>
                  <%= raw tcs("Quantity", (cargo.quantity rescue '')) %>
                  <%= raw tcs("QuantityUnit", (cargo.unit rescue '')) %>
                  <%= raw tcs("UnitPrice", (sprintf("%0.4f", cargo.unit_price) rescue '')) %>
                  <%= raw tcs("TotalPrice", (sprintf("%0.2f", cargo.total_price) rescue '')) %>
                  <%= raw tcs("Currency", (cargo.currency rescue '')) %>
                  <%= raw tcs("FirstQuantity", (cargo.quantity1 rescue '')) %>
                  <%= raw tcs("FirstUnit", (cargo.unit1 rescue '')) %>
                  <% if cargo.quantity2 != 0 %>
                  <%= raw tcs("SecondQuantity", (cargo.quantity2 rescue '')) %>
                  <%= raw tcs("SecondUnit", (cargo.unit2 rescue '')) %>
                  <% else %>
                  <tcs:SecondQuantity xsi:nil="true" />
                  <tcs:SecondUnit xsi:nil="true" />
                  <% end %>
                  <%= raw tcs("OriginCode", (cargo.trade_country rescue '')) %>
                  <% if @declaration.declaration_type == 'export' %>
                  <tcs:Use xsi:nil="true" />
                  <% else %>
                  <%= raw tcs("Use", (@declaration.usage rescue '')) %>
                  <% end %>
                  <%= raw tcs("DutyMode", (cargo.tax_mode rescue '')) %>
                  <tcs:ProcessingCharges xsi:nil="true" />
                  <%= raw tcs("GoodsVersion", (cargo.goods_version rescue '')) %>
                  <tcs:ClassificationMark xsi:nil="true" />
                  <tcs:Note xsi:nil="true" />
              </DecListInformation>
            <% end %>
           </DecList>
			      <% if @declaration.declaration_containers.size > 0 %>
            <DecContainerList>
           	<% @declaration.declaration_containers.each do |container| %>
              <DecContainerInformation>
              	<%= raw tcs("ContainerNo", (container.code rescue '')) %>
              	<%= raw tcs("ContainerSize", (container.container rescue '')) %>
              	<%= raw tcs("ContainerWeight", (Dict::MetalCabinet.find_by_code(container.metal_cabinet).weight rescue '')) %>
              </DecContainerInformation>
            <% end %>
            </DecContainerList>
            <% end %>
            <% if @declaration.attachments.size > 0 %>
            <DecAttachedList>
           	<% @declaration.attachments.each do |key, val| %>
              <DecAttachedInformation>
              	<%= raw tcs("DocumentAttachedCode", (key rescue '')) %>
              	<%= raw tcs("DocumentAttachedNo", (val rescue '')) %>
              </DecAttachedInformation>
            <% end %>
            </DecAttachedList>
            <% end %>

			    <% if @declaration.transit_type == '003' %>
          <% transit_information = @declaration.declaration_transit_information %>
          <TransitHead>
          		<%= raw tcs("WaybillNo", ('000' + @declaration.transport_tool[1..-1] rescue '')) %>
          		<%= raw tcs("MeansOfTransportMode", (transit_information.local_transport_mode rescue '')) %>
          		<%= raw tcs("MeansOfTransportCode", (transit_information.local_transport_tool_code rescue '')) %>
          		<%= raw tcs("MeansOfTransportName", (transit_information.local_transport_tool_name rescue '')) %>
          		<%= raw tcs("MeansOfTransportId", (transit_information.local_transport_tool_voyage_no rescue '')) %>
          		<% truck = Dict::Truck.find_by_code(@declaration.truck) %>
          		<%= raw tcs("CorporationName", (truck.corporation_name rescue '')) %>
          		<%= raw tcs("OrganizationCode", (truck.corporation_code rescue '')) %>
           </TransitHead>

          	<TransitList>
          		<%= raw tcs("BillOfLadingNo", (@declaration.bill_no rescue '')) %>
          		<%= raw tcs("MeansOfTransportCode", (transit_information.transport_tool_code rescue '')) %>
          		<%= raw tcs("MeansOfTransportName", (transit_information.transport_tool_name rescue '')) %>
          		<%= raw tcs("MeansOfTransportId", (transit_information.transport_tool_voyage_no rescue '')) %>
          	</TransitList>
          	<TransitContainerList>
          		<% @declaration.declaration_containers.each_with_index do |container, index| %>
	            <TransitContainerInformation>
	            	<%= raw tcs("ContainerNo", (container.code rescue '')) %>
	            	<%= raw tcs("ContainerNum", index + 1) %>
	            	<%= raw tcs("ContainerSize", (container.container rescue '')) %>
	            	<%= raw tcs("MeansOfTransportName", (transit_information.local_transport_tool_name rescue '')) %>
	            	<%= raw tcs("MeansOfTransportWeight", (Dict::Bracket.find_by_code(container.bracket).weight rescue '')) %>
            	</TransitContainerInformation>
            	<% end %>
            </TransitContainerList>
          <% end %>
             <SignInformation>
                <OperType>C</OperType>
                <%= raw tcs("IcCardNo", (custom_option.ic_card_no rescue '')) %>
                <%= raw tcs("OperName", (@declaration.declarant rescue '')) %>
                <%= raw tcs("OrganizationCode", (enterprise.organization_code rescue '')) %>
                <SignInfo>A001</SignInfo>
                <%= raw tcs("SignDate", (now.strftime('%Y-%m-%dT%H:%M:%S') rescue '')) %>
                <%= raw tcs("CertificateNo", (custom_option.certificate_no rescue '')) %>
            </SignInformation>
				</DecDocument>
			</tcs:TcsData>
		</tcs:TcsFlow201>
	</MessageBody>
</TCS101Message>
